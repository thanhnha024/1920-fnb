name: FCS Wordpress Deploy Via SFTP

run-name: FCS Wordpress Deploy To Server ðŸš€
on:
  push:
    tags:
      - production-*

jobs:
  send_deploying:
    name: Send Telegram Message When Deploying
    runs-on: ubuntu-latest
    env:
      super_secret: ${{ secrets.FPT_DIR_PATH }}
    steps:
      - name: Check if FPT_DIR_PATH is set
        if: ${{ env.super_secret != '' }}
        id: check_secret
        run: echo "FPT_DIR_PATH=${{ secrets.FPT_DIR_PATH }}"

      - name: Send Telegram Message When Deploying
        uses: appleboy/telegram-action@master
        with:
          to: -1002034905977
          token: 6611988217:AAERCNw3lNbdpABmMztQudQXBuPcp1jsKdk
          format: html
          message: |
            <i><code>${{ secrets.FPT_DIR_PATH }}</code><b> Website Deploying... ðŸš€</b></i>

            <b>Details:</b>
            Project name ðŸ’»: ${{ github.repository }}
            Project link ðŸ”Ž: https://${{ secrets.FPT_DIR_PATH }}

  web-deploy-via-sfpt:
    name: ðŸš€ Deploy Website To Production

    runs-on: ubuntu-latest

    needs: send_deploying

    steps:
      - name: ðŸšš Get Latest Code
        uses: actions/checkout@v3

      - name: Use Node.js 20
        uses: actions/setup-node@v2
        with:
          node-version: "20"

      - name: ðŸ”¨ Build Project
        run: |
          npm install
          npm run build

      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{secrets.FPT_SERVER}}
          username: ${{secrets.FPT_USERNAME}}
          password: ${{secrets.FTP_PASSWORD}}
          local-dir: ./src/
          server-dir: /${{secrets.FPT_DIR_PATH}}/
          state-name: state/.sync-state.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/wp-content/plugins/**

  notification-to-telegram:
    runs-on: ubuntu-latest
    needs: [send_deploying, web-deploy-via-sfpt]
    if: |
      always() && 
      (needs.web-deploy-via-sfpt.result == 'success')
    steps:
      - name: Telegram Notification
        uses: appleboy/telegram-action@master

        with:
          to: -1002034905977
          token: 6611988217:AAERCNw3lNbdpABmMztQudQXBuPcp1jsKdk
          format: html
          message: |
            <i><code>${{secrets.FPT_DIR_PATH}}</code><b> Website Deployed âœ…</b></i>

            <b>Details:</b>
            Project name ðŸ’»: ${{ github.repository }}
            Project link ðŸ”Ž: https://github.com/${{ github.repository }}
            See new changes: https://${{secrets.FPT_DIR_PATH}}
